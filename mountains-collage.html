<!DOCTYPE html>
<html>
  <head>
    <title>Mountains</title>
    <meta charset="utf-8">
    <script src="src/jquery-3.6.0.min.js"></script>
    <style>
        body {
            padding: 0px;
            margin: 0px;
            border: 0px;
        }

        main {
            background: red;

            width: 100vw;
            height: 100vh;

            border: 0px;
            padding: 0px;
            margin: 0px;

            overflow: hidden;
        }

        .mountainIframe {
            display: block;
            float: left;

            width: 10%;
            height: 100vh;

            box-sizing: border-box;

            margin: 0px;
            border: 0px;
            padding: 0px;
        }
    </style>

    <!-- if you need to import js scripts do it here -->
  </head>
  <body>
    <main id="mainArea">
        <!-- Will be something like this, but will be created through script -->
        <!-- <iframe id="mountain-1" class="mountainIframe" src="main-nft.html?mountainIndex=0&isCollage=1">
        </iframe>       -->
    </main>



    <!-- WEBPACK will inject the bundle.js here -->
    <script type="text/javascript">

    let mountainIframes = [];
    let mountainStatus = [];

    $(window).on('load', function(){
        startSequence();
    });

    async function startSequence () {
        await createMountainIframes();
        await loadMountainIframes();

        while(true)
        {
            let isAllMountainReady = checkAllMountainReady();

            if(isAllMountainReady)
                break;
            else
                await sleep(100);
        }

        processMountainOffsets();
        await drawMountainsOneByOne ();
    }

    async function createMountainIframes () {
        // some script loading
        let mountainNum = 6;
        let iframeWidth = 100.0 / 6;

        for(let i=0; i< mountainNum; i++)
        {
            let newId = 'mountain-' + i;
            let newIframe = $('<iframe></iframe>').attr('id', newId).addClass('mountainIframe').css('width', iframeWidth + '%');

            let newStatus = {
                'iframeId': newId,
                'ready': false,
                'finishDraw': false,
                'startY':0.0,
                'endY':0.0,
                'alignOffset':0.0
            };

            mountainIframes[i] = newIframe;
            mountainStatus[i] = newStatus;

            // add into html
            $('#mainArea').append(newIframe);
        }
    }

    async function loadMountainIframes () {
        // get ready status first
        for(let i=0; i< mountainIframes.length; i++)
        {
            let targetIframe = mountainIframes[i];

            // this data will be fetching through ETH api in the actual use
            let srcUrl = 'main-nft.html';
            let srcParams = 'mountainIndex=' + i + '&isCollage=1';

            $(targetIframe).attr('src', srcUrl + '?' + srcParams);

            await sleep(50);
        }
    }

    async function drawMountainsOneByOne () {

        // calculate middle line
        let checkPointY = mountainStatus[0].startY;
        let minY = checkPointY;
        let maxY = checkPointY;

        for(let i=0; i< mountainStatus.length; i++)
        {
            checkPointY = mountainStatus[i].endY + mountainStatus[i].alignOffset;

            if(checkPointY > maxY)
                maxY = checkPointY;

            if(checkPointY < minY)
                minY = checkPointY;
        }

        let middleY = (maxY + minY) * 0.5;
        let windowOffset = window.innerHeight * 0.5 - middleY;
        console.log("window things");
        console.log(middleY);
        console.log(window.innerHeight);
        console.log(windowOffset);


        // draw all mountains
        for(let i=0; i< mountainStatus.length; i++)
        {
            mountainStatus[i].alignOffset += windowOffset;
            console.log(mountainStatus[i]);

            startDrawWithOffset(i, mountainStatus[i].alignOffset);

            // wait till draw finish
            while(true)
            {
                if(mountainStatus[i].finishDraw == true)
                {
                    console.log('mountain ' + i + ' draw okay, draw next');
                    break;
                }
                else
                {
                    console.log('mountain ' + i + ' not ready, waiting');
                    await sleep(100);
                }
            }
        }
    }

    function checkAllMountainReady () {
        let allReady = true;
        for(let i=0; i< mountainStatus.length; i++)
        {
            if(mountainStatus[i].ready == false)
            {
                allReady = false;
                break;
            }
        }

        return allReady;
    }

    function processMountainOffsets () {

        console.log(mountainStatus);

        // make mountains connect
        let offsetSum = 0.0;
        for(let i=1; i< mountainStatus.length; i++)
        {
            let diffFromLastMountain = mountainStatus[i-1].endY - mountainStatus[i].startY;
            offsetSum += diffFromLastMountain;

            mountainStatus[i].alignOffset = offsetSum;
        }

        console.log(mountainStatus);
    }

    function startDrawWithOffset (mountainIndex, offsetValue)
    {
        let iframeObj = document.getElementById(mountainStatus[mountainIndex].iframeId);

        let message = {
            'event':'DrawMountainsWithOffset',
            'args': {'offset':offsetValue}
        };
        iframeObj.contentWindow.postMessage(message, '*');
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    window.onmessage = function(e){
        let eventName = e.data.event;
        let args = e.data.args;

        if(e.data.event == "ready")
        {
            let mountainIndex = args.mountainIndex;

            console.log("mountain ready: " + mountainIndex);
            console.log(args);

            mountainStatus[mountainIndex].ready = true;
            mountainStatus[mountainIndex].startY = args.startY;
            mountainStatus[mountainIndex].endY = args.endY;
        }
        else if(e.data.event == 'draw_finish')
        {
            let mountainIndex = args.mountainIndex;

            console.log("mountain draw finish: " + mountainIndex);
            console.log(args);

            mountainStatus[mountainIndex].finishDraw = true;
        }
    };
    </script>
  </body>
</html>
