<!DOCTYPE html>
<html>
  <head>
    <title>Mountains</title>
    <meta charset="utf-8" />
    <script src="src/jquery-3.6.0.min.js"></script>
    <style>
      body {
        padding: 0px;
        margin: 0px;
        border: 0px;
      }

      .mountainIframe {
        display: block;
        float: left;

        width: 20vw;
        height: 100vh;

        box-sizing: border-box;

        margin: 0px;
        border: 0px;
        padding: 0px;
      }
    </style>

    <!-- if you need to import js scripts do it here -->
  </head>
  <body>
    <iframe
      id="mountain-1"
      class="mountainIframe"
      src="./wen/dist/index.html?mountainIndex=0&isCollage=1"
    >
    </iframe>

    <iframe
      id="mountain-2"
      class="mountainIframe"
      src="./wen/dist/index.html?mountainIndex=1&isCollage=1"
    >
    </iframe>

    <iframe
      id="mountain-3"
      class="mountainIframe"
      src="./wen/dist/index.html?mountainIndex=2&isCollage=1"
    >
    </iframe>

    <iframe
      id="mountain-4"
      class="mountainIframe"
      src="./wen/dist/index.html?mountainIndex=3&isCollage=1"
    >
    </iframe>

    <iframe
      id="mountain-5"
      class="mountainIframe"
      src="./wen/dist/index.html?mountainIndex=4&isCollage=1"
    >
    </iframe>

    <!-- WEBPACK will inject the bundle.js here -->
    <script type="text/javascript">
      let mountainStatus = [];

      for (let i = 0; i < 5; i++) {
        mountainStatus[i] = {
          iframeId: "mountain-" + (i + 1),
          ready: false,
          startY: 0.0,
          endY: 0.0,
          alignOffset: 0.0,
        };
      }

      window.onmessage = function (e) {
        let eventName = e.data.event;
        let args = e.data.args;

        if (e.data.event == "ready") {
          let mountainIndex = args.mountainIndex;

          console.log("mountain ready: " + mountainIndex);
          console.log(args);

          mountainStatus[mountainIndex].ready = true;
          mountainStatus[mountainIndex].startY = args.startY;
          mountainStatus[mountainIndex].endY = args.endY;

          checkAllMountainReady();
          //startDrawWithOffset(mountainIndex, (Math.random() - 0.5) * 1000);
        }
      };

      function checkAllMountainReady() {
        let allReady = true;
        for (let i = 0; i < mountainStatus.length; i++) {
          if (mountainStatus[i].ready == false) {
            allReady = false;
            break;
          }
        }

        if (allReady) {
          console.log("ALL READY!");
          console.log(mountainStatus);

          processMountainOffsets();
        }
      }

      function processMountainOffsets() {
        // make mountains connect
        let offsetSum = 0.0;
        for (let i = 1; i < mountainStatus.length; i++) {
          let diffFromLastMountain =
            mountainStatus[i - 1].endY - mountainStatus[i].startY;
          offsetSum += diffFromLastMountain;

          mountainStatus[i].alignOffset = offsetSum;
        }

        // calculate middle line
        let checkPointY = mountainStatus[0].startY;
        let minY = checkPointY;
        let maxY = checkPointY;

        for (let i = 0; i < mountainStatus.length; i++) {
          checkPointY = mountainStatus[i].endY + mountainStatus[i].alignOffset;

          if (checkPointY > maxY) maxY = checkPointY;

          if (checkPointY < minY) minY = checkPointY;
        }

        let middleY = (maxY + minY) * 0.5;
        let windowOffset = window.innerHeight * 0.5 - middleY;
        // console.log("window things");
        // console.log(middleY);
        // console.log(window.innerHeight);
        // console.log(windowOffset);

        // draw all mountains
        for (let i = 0; i < mountainStatus.length; i++) {
          mountainStatus[i].alignOffset += windowOffset;
          startDrawWithOffset(i, mountainStatus[i].alignOffset);
        }
      }

      function startDrawWithOffset(mountainIndex, offsetValue) {
        console.log("startDrawWithOffset", mountainIndex);
        let iframeObj = document.getElementById(
          mountainStatus[mountainIndex].iframeId
        );

        let message = {
          event: "DrawMountainsWithOffset",
          args: { offset: offsetValue },
        };

        setTimeout(() => {
          iframeObj.contentWindow.postMessage(message, "*");
        }, 8000 * mountainIndex);
      }
    </script>
  </body>
</html>
